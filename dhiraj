<html>
<head>
    <title>Compliance Monitoring</title>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />

    <!-- Bootstrap + DataTables -->
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/css/bootstrap-theme.min.css">

    <script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.3/jquery.min.js"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/js/bootstrap.min.js"></script>
    <link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/r/dt/jq-2.1.4,jszip-2.5.0,pdfmake-0.1.18,dt-1.10.9,af-2.0.0,b-1.0.3,b-colvis-1.0.3,b-html5-1.0.3,b-print-1.0.3,se-1.0.1/datatables.min.css"/>
    <script type="text/javascript" src="https://cdn.datatables.net/r/dt/jq-2.1.4,jszip-2.5.0,pdfmake-0.1.18,dt-1.10.9,af-2.0.0,b-1.0.3,b-colvis-1.0.3,b-html5-1.0.3,b-print-1.0.3,se-1.0.1/datatables.min.js"></script>
    <script type="text/javascript" src="script/script.js"></script>

    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">

    <style>
        :root {
            --primary-color: #1a73e8;
            --secondary-color: #185abc;
            --accent-color: #00bfa5;
            --background-light: #f4f7fb;
            --glass-bg: rgba(255, 255, 255, 0.9);
            --text-dark: #2c3e50;
            --text-light: #ffffff;
        }

        body {
            font-family: 'Poppins', sans-serif;
            background: linear-gradient(120deg, #e0f7fa, #e3f2fd, #ede7f6);
            background-size: 300% 300%;
            animation: gradientBG 15s ease infinite;
            margin: 0;
            padding: 0;
            color: var(--text-dark);
        }

        @keyframes gradientBG {
            0% {background-position: 0% 50%;}
            50% {background-position: 100% 50%;}
            100% {background-position: 0% 50%;}
        }

        /* Top header with logo */
        .top_container {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 18px 30px;
            background: linear-gradient(90deg, var(--primary-color), var(--secondary-color));
            color: var(--text-light);
            box-shadow: 0 4px 10px rgba(0,0,0,0.15);
            border-radius: 0 0 20px 20px;
            position: relative;
            z-index: 100;
        }

        .top_container img {
            height: 45px;
            margin-right: 12px;
        }

        .logo-section {
            display: flex;
            align-items: center;
            font-size: 1.4rem;
            font-weight: 700;
            letter-spacing: 1px;
        }

        .top_container a {
            color: var(--text-light);
            background: var(--accent-color);
            padding: 8px 18px;
            border-radius: 30px;
            text-decoration: none;
            font-size: 0.9rem;
            transition: all 0.3s ease;
        }

        .top_container a:hover {
            background: #00897b;
            transform: translateY(-2px);
        }

        /* Scrolling notice */
        marquee {
            background: var(--glass-bg);
            padding: 12px;
            margin: 20px auto;
            width: 90%;
            border-radius: 12px;
            font-size: 1rem;
            box-shadow: 0 6px 20px rgba(0,0,0,0.08);
        }

        /* Data container */
        .middle_container {
            margin: 20px auto;
            max-width: 95%;
        }

        #data {
            background: var(--glass-bg);
            border-radius: 16px;
            box-shadow: 0 8px 24px rgba(0,0,0,0.12);
            padding: 20px;
        }

        /* Table Styling */
        table.dataTable {
            border-radius: 12px;
            overflow: hidden;
        }

        th {
            background: var(--primary-color) !important;
            color: white !important;
            font-size: 0.85rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        td {
            background: rgba(255,255,255,0.95) !important;
            font-size: 0.85rem;
        }

        tr:hover td {
            background: rgba(230, 244, 255, 0.7) !important;
        }

        /* Buttons */
        .buttons-html5 {
            background: var(--accent-color) !important;
            border-radius: 30px !important;
            padding: 6px 16px !important;
            font-size: 0.85rem !important;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .buttons-html5:hover {
            background: #009688 !important;
            transform: scale(1.05);
        }

        /* Footer select filters */
        tfoot select {
            border: 1px solid #ccc;
            border-radius: 6px;
            padding: 4px;
        }

        /* Pagination */
        .paginate_button.current {
            background: var(--primary-color) !important;
            border-radius: 30px !important;
            color: white !important;
        }
    </style>
</head>

<body>
    <div class="container-fluid top_container">
        <div class="logo-section">
            <img src="https://dummyimage.com/150x50/1a73e8/ffffff&text=EIS" alt="EIS Logo">
            <span>PROD Compliance Monitoring Dashboard</span>
        </div>
        <a href="data/service_status.csv">â¬‡ Download CSV</a>
    </div>

    <marquee direction="left">
        The data on this Portal is updated on an hourly basis. Last refresh: <span id="refreshTime"></span>
    </marquee>

    <div class="container-fluid middle_container">
        <div class="row">
            <div class="col-sm-12" id="data">
                <!-- Table generated by JS -->
            </div>
        </div>
    </div>

    <!-- Keep your existing scripts as they are -->
<script>
        // Update refresh time
        document.getElementById('refreshTime').textContent = new Date().toLocaleString();
        
        document.addEventListener("DOMContentLoaded",async ()=> {
            var uid=localStorage.getItem('uidd')
            var password=localStorage.getItem('password')
            try {
                const response = await fetch('https://10.191.171.12:5443/PyPortal/EISHome/authenticatePortal/',{
                    method:'POST',
                    headers:{
                        'Content-Type':'application/json',
                    },
                    body: JSON.stringify({uid,password})
                });
                const data = await response.json();
                if(data.status==302){
                    console.log("login successfull")
                }
                else {
                    window.location.href='https://10.191.171.12:5443/PyPortal/'
                }
            }
            catch(e) {
                console.log("an error occured for login"+e)
            }
        });

        function getData() {
            function createHeader(tr,table,header_list) {
                const thead = document.createElement("thead");
                header_list = ["Server No.","IP Address","File System","Last Updated","Up Time","Server Role","RAM","CPU Core","OS Version","Kernel Version","Kernel Update","Ace Version","MQ Version","Firewall","RPM Count","DS Agent","Splunk","Ragent","Reference ID","System time","eisuser exp","root exp","SOCVA exp","addmitam exp"];
                for(var i=0; i <= header_list.length-1;i++) {
                    const th = document.createElement("th");
                    th.innerHTML=header_list[i];
                    th.classList.add("center");
                    tr.appendChild(th);
                }
                thead.appendChild(tr);
                table.appendChild(thead);
            }
            
            var monthNames=["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"];
            var xhttp = new XMLHttpRequest();
            xhttp.onreadystatechange = function() {
                if (this.readyState == 4 && this.status == 200) {
                    const table = document.createElement("table");
                    const tbody = document.createElement("tbody");
                    table.setAttribute("border","1");
                    table.classList.add("table-responsive");
                    table.classList.add("table-bordered");
                    table.classList.add("display");
                    table.setAttribute("id","myTable");
                    const tr = document.createElement("tr");
                    createHeader(tr,table);
                    const data_div = document.getElementById("data");
                    row_data=this.responseText.split("\n");
                    
                    for (var i = 0; i < row_data.length-1; i++) {
                        col=row_data[i].split(",");
                        col_length = col.length-1
                        const tr1 = document.createElement("tr");
                        const td_counter = document.createElement("td");
                        td_counter.innerHTML=i+1;
                        tr1.appendChild(td_counter);
                        
                        for (let j = 0; j <=col_length ;j++ ) {
                            const td_service = document.createElement("td");
                            td_service.setAttribute("id",col[j]);
                
                            if( col[j] == "DSrunning" ) {
                                span_element = document.createElement("span");
                                span_element.classList.add("glyphicon");
                                span_element.classList.add("glyphicon-ok-circle");
                                span_element.classList.add("avail");
                                td_service.appendChild(span_element);
                            }
                            else if( col[j] == "DSnotrunning" ) {
                                span_element = document.createElement("span");
                                span_element.classList.add("glyphicon");
                                span_element.classList.add("glyphicon-remove-circle");
                                span_element.classList.add("not-avail");
                                td_service.appendChild(span_element);
                            }
                            else if( col[j] == "SPLrunning" ) {
                                span_element = document.createElement("span");
                                span_element.classList.add("glyphicon");
                                span_element.classList.add("glyphicon-ok-circle");
                                span_element.classList.add("avail");
                                td_service.appendChild(span_element);
                            }
                            else if( col[j] == "SPLnotrunning" ) {
                                span_element = document.createElement("span");
                                span_element.classList.add("glyphicon");
                                span_element.classList.add("glyphicon-remove-circle");
                                span_element.classList.add("not-avail");
                                td_service.appendChild(span_element);
                            }
                            else if( col[j] == "Ragentrunning" ) {
                                span_element = document.createElement("span");
                                span_element.classList.add("glyphicon");
                                span_element.classList.add("glyphicon-ok-circle");
                                span_element.classList.add("avail");
                                td_service.appendChild(span_element);
                            }
                            else if( col[j] == "Ragentnotrunning" ) {
                                span_element = document.createElement("span");
                                span_element.classList.add("glyphicon");
                                span_element.classList.add("glyphicon-remove-circle");
                                span_element.classList.add("not-avail");
                                td_service.appendChild(span_element);
                            }
                            else if ( col[j] == "active" ) {
                                span_element = document.createElement("span");
                                span_element.classList.add("glyphicon");
                                span_element.classList.add("glyphicon-ok-circle");
                                span_element.classList.add("avail");
                                td_service.appendChild(span_element);
                            }
                            else if ( col[j] == "inactive" ) {
                                span_element = document.createElement("span");
                                span_element.classList.add("glyphicon");
                                span_element.classList.add("glyphicon-remove-circle");
                                span_element.classList.add("not-avail");
                                td_service.appendChild(span_element);
                            }
                            else if ( col[j] == "DS_someissue" ) {
                                span_element = document.createElement("span");
                                span_element.classList.add("glyphicon");
                                span_element.classList.add("glyphicon-ban-circle");
                                td_service.appendChild(span_element);
                            }
                            else if ( col[j] == "SPL_someissue" ) {
                                span_element = document.createElement("span");
                                span_element.classList.add("glyphicon");
                                span_element.classList.add("glyphicon-ban-circle");
                                td_service.appendChild(span_element);
                            }
                            else if ( col[j] == "undefined" ) {
                                span_element = document.createElement("span");
                                span_element.classList.add("glyphicon");
                                span_element.classList.add("glyphicon-ban-circle");
                                td_service.appendChild(span_element);
                            }
                            else if ( col[j] == "" ) {
                                td_service.innerHTML="issue";
                            }
                            else {
                                var foundMonths=monthNames.filter(month => col[j].includes(month));
                                if ( foundMonths.length > 0 && j != 9) {
                                    console.log("month found in",j);
                                    const today = new Date();
                                    const targetDate=new Date(col[j]);
                                    const diffmili=targetDate-today;
                                    const diff=Math.round(diffmili/(1000 * 60 * 60 * 24));
                                    td_service.innerHTML=col[j];
                                    
                                    if ( diff <=5 ) {
                                        td_service.style.backgroundColor="rgba(229, 62, 62, 0.1)";
                                        td_service.style.fontWeight="500";
                                    }
                                    else if ( diff >=6 && diff <=10 ) {
                                        td_service.style.backgroundColor="rgba(221, 107, 32, 0.1)";
                                        td_service.style.fontWeight="500";
                                    }
                                    else if ( diff <=11 && diff <=15) {
                                        td_service.style.backgroundColor="rgba(56, 161, 105, 0.1)";
                                    }
                                }
                                else {
                                    td_service.innerHTML=col[j];
                                }
                            }
                            tr1.appendChild(td_service);
                            tbody.appendChild(tr1);
                        }
                    }
                    
                    const tfoot = document.createElement("tfoot");
                    const tr_element = document.createElement("tr");
                    header_list = ["Server No.","IP Address","File System","Last Updated","Up Time","Server Role","RAM","CPU Core","OS Version","Kernel Version","Kernel Update","Ace Version","MQ Version","Firewall","RPM Count","DS Agent","Splunk","Ragent","Reference ID","System time","eisuser exp","root exp","SOCVA exp","addmitam exp"];
                    
                    for(var i=0; i <= header_list.length-1;i++) {
                        const th = document.createElement("th");
                        th.innerHTML=header_list[i];
                        th.classList.add("center");
                        tr_element.appendChild(th);
                    }
                    
                    tfoot.appendChild(tr_element);
                    table.appendChild(tbody);
                    table.appendChild(tfoot);
                    data_div.appendChild(table);
                }
            };
            
            let file_name = "data/combine.txt";
            xhttp.open("GET",file_name, true);
            xhttp.send();
            console.log("Table Created");
        }

        getData();
    </script>

    <script type="text/javascript" charset="utf8" src="https://code.jquery.com/jquery-3.7.1.js"></script>
    <script type="text/javascript" charset="utf8" src="https://cdn.datatables.net/2.1.4/js/dataTables.js"></script>
    <script type="text/javascript" charset="utf8" src="https://cdn.datatables.net/buttons/3.1.1/js/dataTables.buttons.js"></script>
    <script type="text/javascript" charset="utf8" src="https://cdn.datatables.net/buttons/3.1.1/js/buttons.dataTables.js"></script>
    <script type="text/javascript" charset="utf8" src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script type="text/javascript" charset="utf8" src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.2.7/pdfmake.min.js"></script>
    <script type="text/javascript" charset="utf8" src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.2.7/vfs_fonts.js"></script>
    <script type="text/javascript" charset="utf8" src="https://cdn.datatables.net/buttons/3.1.1/js/buttons.html5.min.js"></script>
    <script type="text/javascript" charset="utf8" src="https://cdn.datatables.net/buttons/3.1.1/js/buttons.print.min.js"></script>
    <script type="text/javascript" charset="utf8" src="vendor/datatables-plugins/dataTables.bootstrap.min.js"></script>
    <script type="text/javascript" charset="utf8" src="vendor/datatables-responsive/dataTables.responsive.js"></script>

    <script>
        $( window ).on("load", function() {
            initializeDataTable();
        });

        function initializeDataTable() {
            console.log( "applying data table filter ...." );
            var table = $('#myTable').DataTable({
                "processing": true,
                "pageLength": 10,
                dom: 'lBfrtip',
                "lengthMenu": [10,25,50,100],
                "buttons": [
                    {
                        extend: 'collection',
                        text: 'Export',
                        buttons: [
                            'copy',
                            'excel',
                            'csv',
                        ]
                    }
                ],
                "initComplete": function() {
                    // Add subtle animation to table when loaded
                    $('#myTable').addClass('status-change');
                    setTimeout(function() {
                        $('#myTable').removeClass('status-change');
                    }, 500);
                }
            });

            $("#myTable tfoot th").each( function ( i ) {
                var select = $('<select><option value=""></option></select>')
                    .appendTo( $(this).empty() )
                    .on( 'change', function () {
                        table.column( i )
                            .search( $(this).val() )
                            .draw();
                } );

                table.column( i ).data().unique().sort().each( function ( d, j ) {
                    select.append( '<option value="'+d+'">'+d+'</option>' )
                } );
            } );

            console.log( "table filter applied  ...." );
        }

        $(window).on('beforeunload',function(){
            initializeDataTable();
        });
    </script>
</body>
</html>
