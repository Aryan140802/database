<html>
<head>
    <title>Compliance Monitoring</title>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/css/bootstrap-theme.min.css">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.3/jquery.min.js"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/js/bootstrap.min.js"></script>
    <link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/r/dt/jq-2.1.4,jszip-2.5.0,pdfmake-0.1.18,dt-1.10.9,af-2.0.0,b-1.0.3,b-colvis-1.0.3,b-html5-1.0.3,b-print-1.0.3,se-1.0.1/datatables.min.css"/>
    <script type="text/javascript" src="https://cdn.datatables.net/r/dt/jq-2.1.4,jszip-2.5.0,pdfmake-0.1.18,dt-1.10.9,af-2.0.0,b-1.0.3,b-colvis-1.0.3,b-html5-1.0.3,b-print-1.0.3,se-1.0.1/datatables.min.js"></script>
    <script type="text/javascript" src="script/script.js"></script>
    
    <style>
        :root {
            --primary-color: #4a6fa5;
            --secondary-color: #7b9ed9;
            --glass-color: rgba(255, 255, 255, 0.9);
            --glass-border: 1px solid rgba(255, 255, 255, 0.9);
            --glass-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.1);
            --text-color: #2d3748;
            --text-light: #f8f9fa;
            --success-color: #38a169;
            --danger-color: #e53e3e;
            --warning-color: #dd6b20;
            --info-color: #3182ce;
        }
        
        body {
            background: linear-gradient(135deg, #f7fafc 0%, #edf2f7 100%);
            color: var(--text-color);
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            min-height: 100vh;
            margin: 0;
            padding: 0;
            line-height: 1.5;
        }
        
        .top_container {
            display: flex;
            padding: 20px;
            font-weight: 600;
            color: var(--text-light);
            text-align: center;
            background: linear-gradient(135deg, var(--primary-color) 0%, var(--secondary-color) 100%);
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            margin-bottom: 30px;
            align-items: center;
            font-size: 1.5rem;
            position: relative;
            z-index: 10;
            border-radius: 0 0 12px 12px;
        }
        
        .top_container a {
            color: var(--text-light);
            margin-right: 0px;
            margin-left: auto;
            text-decoration: none;
            padding: 8px 16px;
            border-radius: 8px;
            background: rgba(255, 255, 255, 0.2);
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            font-size: 0.9rem;
            font-weight: 500;
        }
        
        .top_container a:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: translateY(-1px);
        }
        
        .top_container a::before {
            content: "â†“";
            margin-right: 6px;
        }
        
        marquee {
            background: var(--glass-color);
            border: 1px solid rgba(0, 0, 0, 0.05);
            border-radius: 8px;
            padding: 12px 20px;
            margin: 20px auto;
            width: 90%;
            box-shadow: var(--glass-shadow);
            color: var(--text-color);
            font-weight: 500;
            font-size: 1.05rem;
        }
        
        .middle_container {
            margin: 2% auto;
            width: 95%;
            max-width: 1400px;
        }
        
        #data {
            background: var(--glass-color);
            border-radius: 12px;
            overflow: hidden;
            box-shadow: var(--glass-shadow);
            border: 1px solid rgba(0, 0, 0, 0.05);
            padding: 0;
        }
        
        table {
            width: 100%;
            border-collapse: separate;
            border-spacing: 0;
            background: transparent;
        }
        
        .center {
            text-align: center;
        }
        
        th {
            background: linear-gradient(135deg, var(--primary-color) 0%, var(--secondary-color) 100%) !important;
            color: var(--text-light) !important;
            padding: 14px 10px !important;
            font-weight: 600 !important;
            position: sticky;
            top: 0;
            z-index: 10;
            border: none !important;
            font-size: 0.85rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        td {
            background: rgba(255, 255, 255, 0.95) !important;
            padding: 12px 10px !important;
            font-size: 0.85rem !important;
            border-bottom: 1px solid rgba(0, 0, 0, 0.03) !important;
            color: var(--text-color);
            vertical-align: middle;
        }
        
        tr:hover td {
            background: rgba(245, 245, 245, 0.98) !important;
        }
        
        .avail {
            color: var(--success-color) !important;
        }
        
        .not-avail {
            color: var(--danger-color) !important;
        }
        
        .glyphicon {
            font-size: 18px !important;
            vertical-align: middle;
        }
        
        #myTable_wrapper {
            width: 100%;
            background: transparent;
            padding: 20px;
        }
        
        .dataTables_length {
            margin-top: 10px;
            margin-bottom: 15px;
            font-size: 0.9rem;
        }
        
        div.dt-buttons {
            position: relative;
            float: left;
            margin-left: 15px;
            margin-top: 10px;
            margin-bottom: 15px;
        }
        
        .dataTables_filter {
            margin-top: 10px;
            margin-bottom: 15px;
        }
        
        .dataTables_filter label {
            font-size: 0.9rem;
        }
        
        .dataTables_filter input {
            border: 1px solid #ddd;
            border-radius: 4px;
            padding: 5px 10px;
        }
        
        .buttons-html5 {
            background: linear-gradient(135deg, var(--primary-color) 0%, var(--secondary-color) 100%) !important;
            color: white !important;
            border: none !important;
            border-radius: 6px !important;
            padding: 6px 12px !important;
            margin-right: 5px !important;
            transition: all 0.2s ease !important;
            font-size: 0.85rem !important;
            font-weight: 500 !important;
        }
        
        .buttons-html5:hover {
            transform: translateY(-1px) !important;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1) !important;
            opacity: 0.9;
        }
        
        select {
            background: rgba(255, 255, 255, 0.9) !important;
            border: 1px solid rgba(0, 0, 0, 0.1) !important;
            border-radius: 6px !important;
            padding: 6px !important;
            margin: 5px 0 !important;
            font-size: 0.85rem;
        }
        
        tfoot {
            background: linear-gradient(135deg, var(--primary-color) 0%, var(--secondary-color) 100%) !important;
            color: var(--text-light) !important;
        }
        
        tfoot select {
            width: 100%;
            background: rgba(255, 255, 255, 0.95) !important;
        }
        
        .dataTables_info {
            color: var(--text-color) !important;
            font-size: 0.9rem;
        }
        
        .paginate_button {
            border-radius: 6px !important;
            margin: 0 2px !important;
            transition: all 0.2s ease !important;
            font-size: 0.9rem !important;
            padding: 6px 12px !important;
        }
        
        .paginate_button.current {
            background: linear-gradient(135deg, var(--primary-color) 0%, var(--secondary-color) 100%) !important;
            color: white !important;
            border: none !important;
        }
        
        /* Modern scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        
        ::-webkit-scrollbar-track {
            background: rgba(0, 0, 0, 0.05);
            border-radius: 10px;
        }
        
        ::-webkit-scrollbar-thumb {
            background: rgba(0, 0, 0, 0.2);
            border-radius: 10px;
        }
        
        ::-webkit-scrollbar-thumb:hover {
            background: rgba(0, 0, 0, 0.3);
        }
        
        /* Status indicators */
        .status-indicator {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 6px;
        }
        
        .status-active {
            background-color: var(--success-color);
        }
        
        .status-inactive {
            background-color: var(--danger-color);
        }
        
        .status-warning {
            background-color: var(--warning-color);
        }
        
        /* Responsive adjustments */
        @media (max-width: 768px) {
            .top_container {
                font-size: 1.2rem;
                padding: 16px;
            }
            
            .top_container a {
                padding: 6px 12px;
                font-size: 0.8rem;
            }
            
            marquee {
                font-size: 0.95rem;
                padding: 10px 15px;
            }
            
            th, td {
                padding: 10px 6px !important;
                font-size: 0.8rem !important;
            }
            
            #myTable_wrapper {
                padding: 10px;
            }
        }
        
        /* Animation for status changes */
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.1); }
            100% { transform: scale(1); }
        }
        
        .status-change {
            animation: pulse 0.5s ease;
        }
        
        /* Zebra striping for better readability */
        tr:nth-child(even) td {
            background: rgba(250, 250, 250, 0.95) !important;
        }
        
        /* Focus state for better accessibility */
        a:focus, button:focus, select:focus {
            outline: 2px solid var(--primary-color);
            outline-offset: 2px;
        }
    </style>
</head>

<body>
    <div class="container top_container">
        <span style="flex-grow: 1; text-align: center;">PROD Compliance Monitoring Dashboard</span>
        <a href="data/service_status.csv">Download CSV</a>
    </div>

    <marquee direction="left">
        The data on this Portal is updated on an hourly basis. Last refresh: <span id="refreshTime"></span>
    </marquee>

    <div class="container-fluid middle_container">
        <div class="row">
            <div class="col-sm-12" id="data">
                <!-- Table will be inserted here by JavaScript -->
            </div>
        </div>
    </div>

    <script>
        // Update refresh time
        document.getElementById('refreshTime').textContent = new Date().toLocaleString();
        
        document.addEventListener("DOMContentLoaded",async ()=> {
            var uid=localStorage.getItem('uidd')
            var password=localStorage.getItem('password')
            try {
                const response = await fetch('https://10.191.171.12:5443/PyPortal/EISHome/authenticatePortal/',{
                    method:'POST',
                    headers:{
                        'Content-Type':'application/json',
                    },
                    body: JSON.stringify({uid,password})
                });
                const data = await response.json();
                if(data.status==302){
                    console.log("login successfull")
                }
                else {
                    window.location.href='https://10.191.171.12:5443/PyPortal/'
                }
            }
            catch(e) {
                console.log("an error occured for login"+e)
            }
        });

        function getData() {
            function createHeader(tr,table,header_list) {
                const thead = document.createElement("thead");
                header_list = ["Server No.","IP Address","File System","Last Updated","Up Time","Server Role","RAM","CPU Core","OS Version","Kernel Version","Kernel Update","Ace Version","MQ Version","Firewall","RPM Count","DS Agent","Splunk","Ragent","Reference ID","System time","eisuser exp","root exp","SOCVA exp","addmitam exp"];
                for(var i=0; i <= header_list.length-1;i++) {
                    const th = document.createElement("th");
                    th.innerHTML=header_list[i];
                    th.classList.add("center");
                    tr.appendChild(th);
                }
                thead.appendChild(tr);
                table.appendChild(thead);
            }
            
            var monthNames=["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"];
            var xhttp = new XMLHttpRequest();
            xhttp.onreadystatechange = function() {
                if (this.readyState == 4 && this.status == 200) {
                    const table = document.createElement("table");
                    const tbody = document.createElement("tbody");
                    table.setAttribute("border","1");
                    table.classList.add("table-responsive");
                    table.classList.add("table-bordered");
                    table.classList.add("display");
                    table.setAttribute("id","myTable");
                    const tr = document.createElement("tr");
                    createHeader(tr,table);
                    const data_div = document.getElementById("data");
                    row_data=this.responseText.split("\n");
                    
                    for (var i = 0; i < row_data.length-1; i++) {
                        col=row_data[i].split(",");
                        col_length = col.length-1
                        const tr1 = document.createElement("tr");
                        const td_counter = document.createElement("td");
                        td_counter.innerHTML=i+1;
                        tr1.appendChild(td_counter);
                        
                        for (let j = 0; j <=col_length ;j++ ) {
                            const td_service = document.createElement("td");
                            td_service.setAttribute("id",col[j]);
                
                            if( col[j] == "DSrunning" ) {
                                span_element = document.createElement("span");
                                span_element.classList.add("glyphicon");
                                span_element.classList.add("glyphicon-ok-circle");
                                span_element.classList.add("avail");
                                td_service.appendChild(span_element);
                            }
                            else if( col[j] == "DSnotrunning" ) {
                                span_element = document.createElement("span");
                                span_element.classList.add("glyphicon");
                                span_element.classList.add("glyphicon-remove-circle");
                                span_element.classList.add("not-avail");
                                td_service.appendChild(span_element);
                            }
                            else if( col[j] == "SPLrunning" ) {
                                span_element = document.createElement("span");
                                span_element.classList.add("glyphicon");
                                span_element.classList.add("glyphicon-ok-circle");
                                span_element.classList.add("avail");
                                td_service.appendChild(span_element);
                            }
                            else if( col[j] == "SPLnotrunning" ) {
                                span_element = document.createElement("span");
                                span_element.classList.add("glyphicon");
                                span_element.classList.add("glyphicon-remove-circle");
                                span_element.classList.add("not-avail");
                                td_service.appendChild(span_element);
                            }
                            else if( col[j] == "Ragentrunning" ) {
                                span_element = document.createElement("span");
                                span_element.classList.add("glyphicon");
                                span_element.classList.add("glyphicon-ok-circle");
                                span_element.classList.add("avail");
                                td_service.appendChild(span_element);
                            }
                            else if( col[j] == "Ragentnotrunning" ) {
                                span_element = document.createElement("span");
                                span_element.classList.add("glyphicon");
                                span_element.classList.add("glyphicon-remove-circle");
                                span_element.classList.add("not-avail");
                                td_service.appendChild(span_element);
                            }
                            else if ( col[j] == "active" ) {
                                span_element = document.createElement("span");
                                span_element.classList.add("glyphicon");
                                span_element.classList.add("glyphicon-ok-circle");
                                span_element.classList.add("avail");
                                td_service.appendChild(span_element);
                            }
                            else if ( col[j] == "inactive" ) {
                                span_element = document.createElement("span");
                                span_element.classList.add("glyphicon");
                                span_element.classList.add("glyphicon-remove-circle");
                                span_element.classList.add("not-avail");
                                td_service.appendChild(span_element);
                            }
                            else if ( col[j] == "DS_someissue" ) {
                                span_element = document.createElement("span");
                                span_element.classList.add("glyphicon");
                                span_element.classList.add("glyphicon-ban-circle");
                                td_service.appendChild(span_element);
                            }
                            else if ( col[j] == "SPL_someissue" ) {
                                span_element = document.createElement("span");
                                span_element.classList.add("glyphicon");
                                span_element.classList.add("glyphicon-ban-circle");
                                td_service.appendChild(span_element);
                            }
                            else if ( col[j] == "undefined" ) {
                                span_element = document.createElement("span");
                                span_element.classList.add("glyphicon");
                                span_element.classList.add("glyphicon-ban-circle");
                                td_service.appendChild(span_element);
                            }
                            else if ( col[j] == "" ) {
                                td_service.innerHTML="issue";
                            }
                            else {
                                var foundMonths=monthNames.filter(month => col[j].includes(month));
                                if ( foundMonths.length > 0 && j != 9) {
                                    console.log("month found in",j);
                                    const today = new Date();
                                    const targetDate=new Date(col[j]);
                                    const diffmili=targetDate-today;
                                    const diff=Math.round(diffmili/(1000 * 60 * 60 * 24));
                                    td_service.innerHTML=col[j];
                                    
                                    if ( diff <=5 ) {
                                        td_service.style.backgroundColor="rgba(229, 62, 62, 0.1)";
                                        td_service.style.fontWeight="500";
                                    }
                                    else if ( diff >=6 && diff <=10 ) {
                                        td_service.style.backgroundColor="rgba(221, 107, 32, 0.1)";
                                        td_service.style.fontWeight="500";
                                    }
                                    else if ( diff <=11 && diff <=15) {
                                        td_service.style.backgroundColor="rgba(56, 161, 105, 0.1)";
                                    }
                                }
                                else {
                                    td_service.innerHTML=col[j];
                                }
                            }
                            tr1.appendChild(td_service);
                            tbody.appendChild(tr1);
                        }
                    }
                    
                    const tfoot = document.createElement("tfoot");
                    const tr_element = document.createElement("tr");
                    header_list = ["Server No.","IP Address","File System","Last Updated","Up Time","Server Role","RAM","CPU Core","OS Version","Kernel Version","Kernel Update","Ace Version","MQ Version","Firewall","RPM Count","DS Agent","Splunk","Ragent","Reference ID","System time","eisuser exp","root exp","SOCVA exp","addmitam exp"];
                    
                    for(var i=0; i <= header_list.length-1;i++) {
                        const th = document.createElement("th");
                        th.innerHTML=header_list[i];
                        th.classList.add("center");
                        tr_element.appendChild(th);
                    }
                    
                    tfoot.appendChild(tr_element);
                    table.appendChild(tbody);
                    table.appendChild(tfoot);
                    data_div.appendChild(table);
                }
            };
            
            let file_name = "data/combine.txt";
            xhttp.open("GET",file_name, true);
            xhttp.send();
            console.log("Table Created");
        }

        getData();
    </script>

    <script type="text/javascript" charset="utf8" src="https://code.jquery.com/jquery-3.7.1.js"></script>
    <script type="text/javascript" charset="utf8" src="https://cdn.datatables.net/2.1.4/js/dataTables.js"></script>
    <script type="text/javascript" charset="utf8" src="https://cdn.datatables.net/buttons/3.1.1/js/dataTables.buttons.js"></script>
    <script type="text/javascript" charset="utf8" src="https://cdn.datatables.net/buttons/3.1.1/js/buttons.dataTables.js"></script>
    <script type="text/javascript" charset="utf8" src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script type="text/javascript" charset="utf8" src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.2.7/pdfmake.min.js"></script>
    <script type="text/javascript" charset="utf8" src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.2.7/vfs_fonts.js"></script>
    <script type="text/javascript" charset="utf8" src="https://cdn.datatables.net/buttons/3.1.1/js/buttons.html5.min.js"></script>
    <script type="text/javascript" charset="utf8" src="https://cdn.datatables.net/buttons/3.1.1/js/buttons.print.min.js"></script>
    <script type="text/javascript" charset="utf8" src="vendor/datatables-plugins/dataTables.bootstrap.min.js"></script>
    <script type="text/javascript" charset="utf8" src="vendor/datatables-responsive/dataTables.responsive.js"></script>

    <script>
        $( window ).on("load", function() {
            initializeDataTable();
        });

        function initializeDataTable() {
            console.log( "applying data table filter ...." );
            var table = $('#myTable').DataTable({
                "processing": true,
                "pageLength": 10,
                dom: 'lBfrtip',
                "lengthMenu": [10,25,50,100],
                "buttons": [
                    {
                        extend: 'collection',
                        text: 'Export',
                        buttons: [
                            'copy',
                            'excel',
                            'csv',
                        ]
                    }
                ],
                "initComplete": function() {
                    // Add subtle animation to table when loaded
                    $('#myTable').addClass('status-change');
                    setTimeout(function() {
                        $('#myTable').removeClass('status-change');
                    }, 500);
                }
            });

            $("#myTable tfoot th").each( function ( i ) {
                var select = $('<select><option value=""></option></select>')
                    .appendTo( $(this).empty() )
                    .on( 'change', function () {
                        table.column( i )
                            .search( $(this).val() )
                            .draw();
                } );

                table.column( i ).data().unique().sort().each( function ( d, j ) {
                    select.append( '<option value="'+d+'">'+d+'</option>' )
                } );
            } );

            console.log( "table filter applied  ...." );
        }

        $(window).on('beforeunload',function(){
            initializeDataTable();
        });
    </script>
</body>
</html>
